{% extends "base.html" %}
{% block title %}Index{% endblock %}
{% block content %}
{% block head %}
  {{ super() }}
  <script src="../static/query-builder.standalone.min.js"></script>
  <script src="../static/query-builder-elasticsearch.js"></script>
{% endblock %}
    <div class="container">
        <div class="row">
        <div class="col-7" style="margin-left:10px">
          <div class="row">
            <h3>We currently have <i>{{ num_bedfiles }}</i> bed files stored and processed</h3>
          </div>
          <div style="margin-top:15px"></div>
          <div class="row">
              <p>Select your search criteria below:</p>
          </div>
          <div class="row">
              <div id="builder-basic"></div>
          </div>
            <div class="row">
              <div class="btn-group">
                <button id="btn-reset" class="btn btn-warning reset" data-target="basic">Reset <i class="fas fa-undo"></i></button>
                <button id="btn-post-elastic" class="btn btn-primary parse-json" data-target="basic">Search <i class="fas fa-search"></i></button>
                <button id="btn-show-elastic" class="btn btn-secondary parse-json" data-target="basic">Get Elasticsearch query <img src="https://img.icons8.com/color/22/000000/elasticsearch.png"></button>
              </div>
          </div>
          <div style="margin-top:15px"></div>
          <div class="row">
              <div id="search-results"></div>
          </div>
        </div>
          {% if num_bedsets is not none and num_bedsets > 0 %}
            <div class="col-4">
              <div class="row">
                <h3>We currently have <i>{{ num_bedsets }}</i> bed sets stored and processed</h3>
              </div>
            <div class="row" style="margin-left:10px">
                <ul>
                    {% for id, url in bedset_urls.items() %}
                        <li>
                            <a href="{{ url }}">{{ id }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            </div>
          {% endif %}
      </div>
    </div>
    <script>
    $(function() {
        console.log('Handler for .ready() called.')
        <!-- This function is called every time the page is loaded to get the latest result query result -->
        $.get( "/serve_rules", function( data ) {
          console.log("Rules received: " + JSON.stringify(data));
            $('#builder-basic').queryBuilder('setRules', data);
        });
        var request = $.ajax({
            url: "/bedfiles_filter_result?html=True",
            type: "post",
            data: JSON.stringify({"elastic":{current: null}}),
            contentType: "application/json; charset=utf-8",
            dataType: "html"
        });
        request.done(function(data){
            console.log("Data received: " + JSON.stringify(data));
            $('#search-results').html(data);
        });
        request.fail(function(jqXHR, textStatus){
            console.log('Something went wrong: ' + textStatus);
        });
        request.always(function(jqXHR, textStatus) {
           console.log('Ajax request was finished')
        });
    });

    $('#builder-basic').queryBuilder({
      plugins: {
        'bt-tooltip-errors': null
      },

      filters: [
      {% for filter in filters %}
        {
        id: "{{ filter["id"] }}",
        label: "{{ filter["label"] }}",
        type: "{{ filter["type"] }}",
        operators: {{ filter["operators"]|safe }},
        {% if filter["validation"] is not none %}
          validation: {
            min: {{ filter["validation"]["min"] }},
            step: {{ filter["validation"]["step"] }}
          }
        {% endif %}
        }{{ "," if not loop.last }}
      {% endfor %}
      ]
    });

    $('#btn-reset').on('click', function() {
        $('#builder-basic').queryBuilder('reset');
        $('#search-results').html("");
    });

    $('#btn-show-elastic').on('click', function() {
        var result = $('#builder-basic').queryBuilder('getESBool');
        if (!$.isEmptyObject(result)) {
            prompt("Copy the Elasticsearch query to clipboard", JSON.stringify(result, null, 2))
        }
    });

    $('#btn-post-elastic').on('click', function() {
        var current_rules = $('#builder-basic').queryBuilder('getRules');
        var query = $('#builder-basic').queryBuilder('getESBool');
        var request = $.ajax({
            url: "/bedfiles_filter_result?html=True",
            type: "post",
            data: JSON.stringify({"elastic":query,"rules":current_rules}),
            contentType: "application/json; charset=utf-8",
            dataType: "html"
        });
        request.done(function(data){
            console.log("Data received: " + data);
            $('#search-results').html(data);
        });
        request.fail(function(jqXHR, textStatus){
            console.log('Something went wrong: ' + textStatus);
        });
        request.always(function(jqXHR, textStatus) {
            console.log('Ajax request was finished')
        });
    })
    </script>
{% endblock %}
